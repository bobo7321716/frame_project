{"version":3,"sources":["assets\\homePage\\script\\manager\\AppContext.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import StartView from \"../../../start/script/StartView\";\r\nimport { BundleData } from \"../common/BundleData\";\r\nimport { BundleName } from \"../common/BundleName\";\r\nimport LoadingProgressCol from \"../common/LoadingProgressCol\";\r\nimport { PlayerData } from \"../common/PlayerData\";\r\nimport { UiPath } from \"../common/UiPath\";\r\nimport { AbManager } from \"./AbManager\";\r\nimport { AudioManager } from \"./AudioManager\";\r\nimport DataManager from \"./DataManager\";\r\nimport StoryManager from \"./StoryManager\";\r\nimport { UIManager } from \"./UIManager\";\r\n\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\ndeclare global {\r\n    interface Window {\r\n        appContext: AppContext;\r\n    }\r\n    export let appContext: AppContext;\r\n}\r\n\r\n@ccclass\r\nexport default class AppContext extends cc.Component {\r\n\r\n    @property({ displayName: \"版本号\" })\r\n    version: string = \"0.0.1\";\r\n\r\n    @property(LoadingProgressCol)\r\n    loadingCol: LoadingProgressCol = null;\r\n\r\n    @property(cc.Node)\r\n    flyCameraNode: cc.Node = null;\r\n\r\n    private loadList1: string[] = [BundleName.Font, BundleName.Config, BundleName.Assets, BundleName.Start, BundleName.Common];\r\n\r\n    private preloadlist1: BundleData[] = [];\r\n\r\n    private loadTimer: number = 0;\r\n\r\n    protected onLoad(): void {\r\n        window.appContext = this;\r\n        cc.game.addPersistRootNode(this.node);\r\n\r\n        // var manager = cc.director.getCollisionManager();\r\n        // manager.enabled = true;\r\n        // manager.enabledDebugDraw = true;\r\n\r\n        this.initShiftEvent();\r\n\r\n        console.log(\"操作系统:\", cc.sys.os);\r\n        console.log(\"DEBUG:\", CC_DEBUG);\r\n        if (!CC_DEBUG) {//不是Debug包不用输出log\r\n            // console.log = () => { };\r\n        }\r\n\r\n        if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n            wx.onMemoryWarning(function () {\r\n                // console.error('内存告警! onMemoryWarningReceive');\r\n                wx.triggerGC();\r\n            })\r\n        }\r\n        this.gameInit();\r\n        this.loadingCol.node.active = true;\r\n    }\r\n\r\n    triggerGc() {\r\n        if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n            wx.triggerGC();\r\n        }\r\n    }\r\n\r\n    public gameInit() {\r\n        setInterval(() => {\r\n            this.triggerGc();\r\n            PlayerData.ins.saveData();\r\n        }, 60000)\r\n        this.loadingCol.startProgressAnim();\r\n        this.flyCameraNode.active = false;\r\n        this.onLoadRes();\r\n    }\r\n\r\n    initShiftEvent() {\r\n        if (cc.sys.isBrowser) {\r\n            cc.game.off(cc.game.EVENT_SHOW);\r\n            cc.game.on(cc.game.EVENT_SHOW, () => {\r\n                cc.game.canvas.focus();\r\n                this.gameShowEvent();\r\n            });\r\n            cc.game.off(cc.game.EVENT_HIDE);\r\n            cc.game.on(cc.game.EVENT_HIDE, this.gameHideEvent.bind(this));\r\n        } else if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n            wx.offShow(this.gameShowEvent.bind(this));\r\n            wx.offHide(this.gameHideEvent.bind(this));\r\n            wx.onShow(this.gameShowEvent.bind(this));\r\n            wx.onHide(this.gameHideEvent.bind(this));\r\n        }\r\n    }\r\n\r\n    private gameHideEvent() {\r\n        console.log('cc.game.EVENT_HIDE');\r\n        AudioManager.ins.pauseAllSound();\r\n    }\r\n\r\n    private gameShowEvent() {\r\n        console.log('cc.game.EVENT_SHOW')\r\n        AudioManager.ins.resumeAllSound();\r\n    }\r\n\r\n    /**\r\n     * 加载资源\r\n     */\r\n    async onLoadRes(): Promise<any> {\r\n        this.loadTimer = Date.now();\r\n        await AbManager.loadSubPackage(this.loadList1);\r\n        await DataManager.ins.init();\r\n        PlayerData.ins.initData();\r\n        StoryManager.ins.init();\r\n        // await AbManager.preloadAssets(this.preloadlist1, cc.Prefab);\r\n        console.log(\"第一步耗时 ： \", Date.now() - this.loadTimer);\r\n        this.loadTimer = Date.now();\r\n        UIManager.ins.openView(UiPath.StartView).then((main: StartView) => {\r\n            main.init().then(() => {\r\n                this.toStartBoard();\r\n            });\r\n            AbManager.preloadAssets(this.preloadlist1, cc.Prefab);\r\n        })\r\n    }\r\n\r\n    toStartBoard() {\r\n        this.loadingCol.finishProgress().then(() => {\r\n            this.loadingCol.node.active = false;\r\n        })\r\n    }\r\n\r\n    preloadAssets() {\r\n        AbManager.preloadBundleDir(BundleName.Assets, \"audios\");\r\n    }\r\n\r\n    /**\r\n     * 退出游戏\r\n     */\r\n    public exitGame() {\r\n        PlayerData.ins.saveData();\r\n        if (cc.sys.platform == cc.sys.WECHAT_GAME) {\r\n            wx.exitMiniProgram({});\r\n        } else {\r\n            cc.game.end();\r\n        }\r\n    }\r\n\r\n    clearDataClick() {\r\n        cc.sys.localStorage.clear();\r\n    }\r\n\r\n    private lastObj = {};\r\n    contrastAssetsMap() {\r\n        console.warn(\"cc.assetManager.assets = \", cc.assetManager.assets)\r\n        if (Object.keys(this.lastObj).length <= 0) {\r\n            let obj = cc.assetManager.assets._map;\r\n            for (const key in obj) {\r\n                this.lastObj[key] = obj[key];\r\n            }\r\n            console.warn(\"this.lastObj = \", this.lastObj)\r\n        } else {\r\n            let arr = [];\r\n            let newObj = cc.assetManager.assets._map;\r\n            for (const key in newObj) {\r\n                let has = key in this.lastObj;\r\n                if (!has) {\r\n                    // console.log(newObj[key]);\r\n                    arr.push(newObj[key])\r\n                }\r\n            }\r\n            this.lastObj = {};\r\n            console.warn(\"newObj[key] = \", arr)\r\n        }\r\n    }\r\n}\r\n"]}